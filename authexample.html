<html>
<head>
	<link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.1/css/bootstrap.min.css" rel="stylesheet">
	<script src="https://code.jquery.com/jquery-2.1.3.js"></script>
	<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.1/js/bootstrap.min.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/jsSHA/1.5.0/sha256.js"></script>
	<style>
		.divider {
			width: 100%;
			height: 3em;
			border-top: solid 1px grey;
		}
		dd, p {
			padding-top: 5px;
			padding-bottom: 10px;
		}
		.info {
		    background: #B75FC6;
		    border-radius: 3px;
		    padding: 0.3rem;
		    font-size: 2rem;
		    color: white;
		}
		.info a {
			color:white;
		}
	</style>
</head>
<body>
	<div class="container">
		<div class="jumbotron">
			<h2>PlanMill authentication example</h2>
		</div>

	<p class="info">Note: OAuth2/OpenID Connect standard authentication coming soon 03-04/2016. You can start planning your client implementation by checking the generic information and language specific libraries here <a href="http://openid.net/developers/libraries/">http://openid.net/developers/libraries/</a></p>

	<h1> Example Javascript -code</h1>

	<pre>

	// Simple random string generation function.
	var stringGen = function(len) {
			var text = '',
				charset = 'abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';

			for( var i=1; i < len; i++ ) {
				text += charset.charAt(Math.floor(Math.random() * charset.length));
			}
			
			return text;
	};

	var clearFields = function() {
			$("#nonce").val('');
			$("#timestamp").val('');
			$("#signature").val('');
			$("#header").val('');
			$("#user_id").val('');
			$("#api_key").val('');
	}


	var calculate = function() {
	
		var userId = $("#user_id").val(),
			apiKey = $("#api_key").val();

		if (userId == '') {
			userId = '12345678';
			$("#user_id").val(userId);
		}	

		if (apiKey == '') {
			apiKey = 'WQuXqWYxx6VIYBmG5W16THIIgULKCNns';
			$("#api_key").val(apiKey);
		}

		var nonce = stringGen(8),
			timestamp = parseInt(new Date().getTime()/1000),
			message = userId + nonce + timestamp,
			sha256 = new jsSHA(message, 'ASCII'),
			signature = sha256.getHMAC(apiKey, 'ASCII', 'SHA-256', 'B64'),
			header = 'x-PlanMill-Auth: user:'+userId+';nonce:'+nonce+';timestamp:'+timestamp+';signature:'+signature;
			
			$("#nonce").val(nonce);
			$("#timestamp").val(timestamp);
			$("#signature").val(signature);
			$("#header").val(header);
			
	};
	
	$("#generate").on('click', function() {
		calculate();
	});

	$("#clear").on('click', function() {
		clearFields();
	});

</pre>


		<div class="row">


			<div class="col-lg-3">
				
				<label for="user_id">Input values</label><BR>
				<input id="user_id" type="textfield" class="form-control" name="user_id" placeholder="User's internal Id"></input><BR>
				<input id="api_key" type="textfield" class="form-control" name="api_key" placeholder="User's API Key"></input><BR>
				
				<button class="btn btn-primary" id="generate">Generate header!</button>
				<button class="btn btn-secondary" id="clear">Clear fields</button>
				
				<br/>
				
				<p>You can find the example JavaScript code by looking at the source code of this page.</p>
			</div>
			<div class="col-lg-9" class="input-group">
				<label>Generated values</label>
				<input class="form-control" id="nonce" placeholder="Random generated Nonce:" disabled></input><br>
				<input class="form-control" id="timestamp" placeholder="Current timestamp:" disabled></input><br>
				<input class="form-control" id="signature" placeholder="Generated signature:" disabled></input><br>
				<input class="form-control" id="header" placeholder="The whole header:" disabled></input><br>
			</div>
		</div>
		<div class="col-lg-12 divider"></div>
		<div class="row">
			
			<div class="col-lg-12">
				<div class="col-lg-4">



					<h3>Explanation of fields</h3>
					<dl>
						<dt>Nonce</dt>
						<dd>Unique 4-8 characters long string composed of upper and lower case letters and numbers. Each nonce can only be used once so it must be regenerated for each request</dd>
						<dt>Timestamp</dt>
						<dd>Timestamp in epoch format that represents the time when the request was sent. The timestamp must not be over 60 seconds old by the time the server processes it</dd>
						<dt>Signature</dt>
						<dd>Signature is a hash-based message authentication code (HMAC) created from the SHA256 hashed user id, nonce and timestamp using the API key as the cryptographic key.</dd>
						<dt>Header</dt>
						<dd>HTTP header included in each API request for authentication of the API user.</dd>
					</dl>
				</div>
				<div class="col-lg-8">
					<h3>Acquiring the user ID and API key for authentication</h3>
					<p>Before you can use the API you need to know your internal user ID and have an API key. Follow these steps to find out your ID and how to create your API key</p>
					<ol class="list-group">
						<li>Navigate to the API test instance <a href="https://online.planmill.com/openapi">https://online.planmill.com/openapi</a> (or any PlanMill instance to which you have user account and which you want to use the API with)</li>
						<li>Sign in</li>
						<li>My workspace opens and in the top right corner you see your name.</li>
						<li>Click your name to open a navigation list</li>
						<li>Select <b>My page</b></li>
						<li>A page opens with your user information. Your internal user id is listed in the User settings sections under the name <b>Internal ID</b></li>
						<li>You should see <b>API 1.5 key</b> button in the top section (if you don't, it means API is not activated to your PlanMill instance. Ask your company's PlanMill power user if API can be activated to your instance and to your user role. This requires contacting PlanMill.</li>
						<li>Click on the tool and an popup opens</li>
						<li>Click <b>Generate</b> to generate an API key.</li>
						<li>A 32 character long string of characters and numbers should appear in the prompt. This is your personal API key</li>
					</ol>
				</div>
			</div>
		</div>
	</div>
</body>
<script>

	// Simple random string generation function.
	var stringGen = function(len) {
			var text = '',
				charset = 'abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';

			for( var i=1; i < len; i++ ) {
				text += charset.charAt(Math.floor(Math.random() * charset.length));
			}
			
			return text;
	};

	var clearFields = function() {
			$("#nonce").val('');
			$("#timestamp").val('');
			$("#signature").val('');
			$("#header").val('');
			$("#user_id").val('');
			$("#api_key").val('');
	}


	var calculate = function() {
	
		var userId = $("#user_id").val(),
			apiKey = $("#api_key").val();

		if (userId == '') {
			userId = '12345678';
			$("#user_id").val(userId);
		}	

		if (apiKey == '') {
			apiKey = 'WQuXqWYxx6VIYBmG5W16THIIgULKCNns';
			$("#api_key").val(apiKey);
		}

		var nonce = stringGen(8),
			timestamp = parseInt(new Date().getTime()/1000),
			message = userId + nonce + timestamp,
			sha256 = new jsSHA(message, 'ASCII'),
			signature = sha256.getHMAC(apiKey, 'ASCII', 'SHA-256', 'B64'),
			header = 'x-PlanMill-Auth: user:'+userId+';nonce:'+nonce+';timestamp:'+timestamp+';signature:'+signature;
			
			$("#nonce").val(nonce);
			$("#timestamp").val(timestamp);
			$("#signature").val(signature);
			$("#header").val(header);
			
	};
	
	$("#generate").on('click', function() {
		calculate();
	});

	$("#clear").on('click', function() {
		clearFields();
	});

</script>



</script>
</html>
